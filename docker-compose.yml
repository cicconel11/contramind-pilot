services:
  postgres:
    image: postgres:16-alpine
    container_name: cm-postgres
    environment:
      POSTGRES_USER: cm
      POSTGRES_PASSWORD: cm
      POSTGRES_DB: cm
    ports:
      - "5433:5432"
    volumes:
      - ./db/init:/docker-entrypoint-initdb.d:ro

  worldcheck:
    build: ./services/worldcheck
    container_name: cm-worldcheck
    environment:
      WC_LATENCY_MAX_MS: "1500"
    ports:
      - "8081:8080"
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/metrics"]
      interval: 10s
      timeout: 3s
      retries: 5

  attestor:
    build: ./services/attestor
    container_name: cm-attestor
    environment:
      ATTESTOR_KEYS: "ed25519:v1:demo-seed-change-me;ed25519:v2:next-rotating-seed"
      ATTESTOR_ACTIVE_KID: "v1"
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/metrics"]
      interval: 10s
      timeout: 3s
      retries: 5

  client:
    build: ./services/client
    container_name: cm-client
    depends_on:
      - postgres
      - attestor
    environment:
      PGHOST: postgres
      PGUSER: cm
      PGPASSWORD: cm
      PGDATABASE: cm
      PGPORT: "5432"
      ATTESTOR_URL: "http://attestor:8080"
      WORLDCHECK_URL: "http://worldcheck:8080"
    command: ["python", "demo.py"]

  control:
    build: ./services/control
    container_name: cm-control
    environment:
      ADMIN_TOKEN: "changeme"
      PGHOST: postgres
      PGUSER: cm
      PGPASSWORD: cm
      PGDATABASE: cm
      PGPORT: "5432"
    ports:
      - "8083:8080"
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  prometheus:
    image: prom/prometheus
    container_name: cm-prometheus
    volumes:
      - ./ops/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./ops/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - ./ops/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - worldcheck
      - attestor
      - control

  alertmanager:
    image: prom/alertmanager
    container_name: cm-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./ops/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

  grafana:
    image: grafana/grafana
    container_name: cm-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    depends_on:
      - prometheus

  anchor:
    build: ./services/anchor
    container_name: cm-anchor
    depends_on:
      - postgres
      - attestor
    environment:
      PGHOST: postgres
      PGUSER: cm
      PGPASSWORD: cm
      PGDATABASE: cm
      PGPORT: "5432"
      ATTESTOR_URL: "http://attestor:8080"

  # mTLS proxies
  attestor-proxy:
    image: caddy:2
    container_name: cm-attestor-proxy
    depends_on: [attestor]
    ports:
      - "8443:8443"
    volumes:
      - ./ops/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./ops/certs:/certs:ro

  worldcheck-proxy:
    image: caddy:2
    container_name: cm-worldcheck-proxy
    depends_on: [worldcheck]
    ports:
      - "8444:8444"
    volumes:
      - ./ops/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./ops/certs:/certs:ro

  control-proxy:
    image: caddy:2
    container_name: cm-control-proxy
    depends_on: [control]
    ports:
      - "8445:8445"
    volumes:
      - ./ops/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./ops/certs:/certs:ro

  decider:
    build: ./services/decider
    container_name: cm-decider
    depends_on:
      - postgres
      - attestor
      - worldcheck
    environment:
      PGHOST: postgres
      PGUSER: cm
      PGPASSWORD: cm
      PGDATABASE: cm
      PGPORT: "5432"
      ATTESTOR_URL: "http://attestor:8080"
      WORLDCHECK_URL: "http://worldcheck:8080"
    ports:
      - "8084:8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  backups:
    image: alpine:3.20
    container_name: cm-backups
    volumes:
      - ./ops:/ops
    command: ["sh","-lc","echo '0 2 * * * /ops/backup.sh' | crontab - && crond -f -L /dev/stdout"]
    depends_on: [postgres]

  loki:
    image: grafana/loki:2.9.8
    container_name: cm-loki
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki

  promtail:
    image: grafana/promtail:2.9.8
    container_name: cm-promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./ops/promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on: [loki]

volumes:
  loki-data:
