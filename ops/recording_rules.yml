# ops/recording_rules.yml
groups:
- name: contramind-sli
  interval: 30s
  rules:
  - record: job:http_req_total:rate5m
    expr: sum by (job,handler) (rate(http_request_duration_seconds_count[5m]))
  - record: job:http_req_errors:rate5m
    expr: sum by (job,handler) (rate(http_request_duration_seconds_count{status!~"^2.."}[5m]))
  - record: slo:availability:attestor_sign
    expr: 1 - (job:http_req_errors:rate5m{job="attestor",handler="/sign"} / job:http_req_total:rate5m{job="attestor",handler="/sign"})
  - record: slo:availability:attestor_verify
    expr: 1 - (job:http_req_errors:rate5m{job="attestor",handler="/verify"} / job:http_req_total:rate5m{job="attestor",handler="/verify"})
  - record: slo:availability:worldcheck_verify
    expr: 1 - (job:http_req_errors:rate5m{job="worldcheck",handler="/verify"} / job:http_req_total:rate5m{job="worldcheck",handler="/verify"})
  - record: slo:availability:control_params
    expr: 1 - (job:http_req_errors:rate5m{job="control",handler=~"/param/.*"} / job:http_req_total:rate5m{job="control",handler=~"/param/.*"})
  - record: slo:latency_p95:attestor_sign
    expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job="attestor",handler="/sign"}[5m])))
  - record: slo:latency_p95:attestor_verify
    expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job="attestor",handler="/verify"}[5m])))
  - record: slo:latency_p95:worldcheck_verify
    expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job="worldcheck",handler="/verify"}[5m])))
  - record: slo:latency_p95:control_params
    expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job="control",handler=~"/param/.*"}[5m])))
  - record: slo:integrity:signature_verification_failures
    expr: rate(http_request_duration_seconds_count{job="attestor",handler="/verify",status!~"^2.."}[5m]) / rate(http_request_duration_seconds_count{job="attestor",handler="/verify"}[5m])
